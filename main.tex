\documentclass[12pt,letterpaper,final]{amsart}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage[bookmarks=true, colorlinks=true]{hyperref}
\usepackage{setspace}
% Graphics
\usepackage{graphicx}
\usepackage{epstopdf}
\DeclareGraphicsRule{.eps}{pdf}{.pdf}{`epstopdf #1}
\pdfcompresslevel=9

\setlength{\voffset}{0in}
\setlength{\hoffset}{0in}
\setlength{\oddsidemargin}{0in}
\setlength{\evensidemargin}{0in}
\setlength{\marginparwidth}{0in}
\setlength{\textwidth}{6.5in}
\setlength{\parskip}{1ex}
\doublespacing
\raggedright

\usepackage[numbers,sort&compress]{natbib}

% Front matter
\author{Joel Vincent Bernier}
\title{A general geometric model for parameterizing diffraction measurements}

% some macros
\newcommand{\mbm}[1]{\ensuremath{\mbox{\boldmath$#1$}}}

\newcommand{\tvecd}{\ensuremath{\mbm{\mathrm{t}}_d}}
\newcommand{\tvecs}{\ensuremath{\mbm{\mathrm{t}}_s}}
\newcommand{\tvecc}{\ensuremath{\mbm{\mathrm{t}}_c}}
\newcommand{\rmatd}{\ensuremath{\mathsf{R}_d}}
\newcommand{\rmats}{\ensuremath{\mathsf{R}_s}}
\newcommand{\rmatc}{\ensuremath{\mathsf{R}_c}}
\newcommand{\amat}{\ensuremath{\mathsf{A}}}
\newcommand{\bmat}{\ensuremath{\mathsf{B}}}
\newcommand{\gvec}{\ensuremath{\mbm{\mathrm{G}}}}
\newcommand{\ghat}{\ensuremath{\hat{\mbm{\mathrm{G}}}}}
\newcommand{\bhat}{\ensuremath{\hat{\mbm{\mathrm{b}}}}}
\newcommand{\dhat}{\ensuremath{\hat{\mbm{\mathrm{d}}}}}
\newcommand{\ehat}{\ensuremath{\hat{\mbm{\mathrm{e}}}}}
\newcommand{\eye}{\ensuremath{\mbm{\mathrm{I}}}}
\newcommand{\vmat}{\ensuremath{\mbm{\mathrm{V}}}}
\newcommand{\defgrad}{\ensuremath{\mbm{\mathrm{F}}}}
\newcommand{\detpt}{\ensuremath{\mbm{\mathrm{x}}}}

\newcommand{\ghati}{\ensuremath{\hat{G}_{i}}}
\newcommand{\bhati}{\ensuremath{\hat{b}_{i}}}
\newcommand{\dhati}{\ensuremath{\hat{d}_{i}}}
\newcommand{\ghatj}{\ensuremath{\hat{G}_{j}}}
\newcommand{\bhatj}{\ensuremath{\hat{b}_{j}}}
\newcommand{\dhatj}{\ensuremath{\hat{d}_{j}}}

% points
\newcommand{\Pzero}{\ensuremath{\mathrm{P0}}}
\newcommand{\Pone}{\ensuremath{\mathrm{P1}}}
\newcommand{\Ptwo}{\ensuremath{\mathrm{P2}}}
\newcommand{\Pthree}{\ensuremath{\mathrm{P3}}}
\newcommand{\Pfour}{\ensuremath{\mathrm{P4}}}

% coordinate axes
\newcommand{\Xl}{\ensuremath{\hat{\mbm{\mathrm{X}}}_l}}
\newcommand{\Yl}{\ensuremath{\hat{\mbm{\mathrm{Y}}}_l}}
\newcommand{\Zl}{\ensuremath{\hat{\mbm{\mathrm{Z}}}_l}}
\newcommand{\labframe}{\ensuremath{\left\{\Xl\Yl\Zl\right\}}}

\newcommand{\Xb}{\ensuremath{\hat{\mbm{\mathrm{X}}}_b}}
\newcommand{\Yb}{\ensuremath{\hat{\mbm{\mathrm{Y}}}_b}}
\newcommand{\Zb}{\ensuremath{\hat{\mbm{\mathrm{Z}}}_b}}
\newcommand{\beamframe}{\ensuremath{\left\{\Xb\Yb\Zb\right\}}}

\newcommand{\Xd}{\ensuremath{\hat{\mbm{\mathrm{X}}}_d}}
\newcommand{\Yd}{\ensuremath{\hat{\mbm{\mathrm{Y}}}_d}}
\newcommand{\Zd}{\ensuremath{\hat{\mbm{\mathrm{Z}}}_d}}
\newcommand{\detframe}{\ensuremath{\left\{\Xd\Yd\Zd\right\}}}

\newcommand{\Xs}{\ensuremath{\hat{\mbm{\mathrm{X}}}_s}}
\newcommand{\Ys}{\ensuremath{\hat{\mbm{\mathrm{Y}}}_s}}
\newcommand{\Zs}{\ensuremath{\hat{\mbm{\mathrm{Z}}}_s}}
\newcommand{\sampframe}{\ensuremath{\left\{\Xs\Ys\Zs\right\}}}

\newcommand{\Xc}{\ensuremath{\hat{\mbm{\mathrm{X}}}_c}}
\newcommand{\Yc}{\ensuremath{\hat{\mbm{\mathrm{Y}}}_c}}
\newcommand{\Zc}{\ensuremath{\hat{\mbm{\mathrm{Z}}}_c}}
\newcommand{\crysframe}{\ensuremath{\left\{\Xc\Yc\Zc\right\}}}

% vector components
\newcommand{\labcomps}[1]{\left[#1\right]_l}
\newcommand{\beamcomps}[1]{\left[#1\right]_b}
\newcommand{\detcomps}[1]{\left[#1\right]_d}
\newcommand{\sampcomps}[1]{\left[#1\right]_s}
\newcommand{\cryscomps}[1]{\left[#1\right]_c}
\newcommand{\rcpcomps}[1]{\left[#1\right]_*}

% cross-references
\newcommand{\figref}[1]{Figure~\ref{#1}}
\newcommand{\eqnref}[1]{Equation~\ref{#1}}
\newcommand{\secref}[1]{\S~\ref{#1}}

% miscellaneous
\newcommand{\ie}{{\em i.e.}}
\newcommand{\eg}{{\em e.g.}}
\newcommand{\cf}{{\em cf.}}
\newcommand{\xray}{X-ray}
\newcommand{\xrays}{X-rays}

\newcommand{\gx}{\ensuremath{\gamma_x}}
\newcommand{\gy}{\ensuremath{\gamma_y}}
\newcommand{\gz}{\ensuremath{\gamma_z}}

\newcommand{\crysdir}{\ensuremath{\mathbf{h}}}
\newcommand{\sampdir}{\ensuremath{\mathbf{s}}}
\newcommand{\hkls}{\ensuremath{hkl}}
\newcommand{\bhkls}{\ensuremath{\bar{h}\bar{k}\bar{l}}}

\newcommand{\cella}{\ensuremath{\mathbf{a}}}
\newcommand{\cellb}{\ensuremath{\mathbf{b}}}
\newcommand{\cellc}{\ensuremath{\mathbf{c}}}
\newcommand{\dalfa}{\ensuremath{\alpha}}
\newcommand{\dbeta}{\ensuremath{\beta}}
\newcommand{\dgama}{\ensuremath{\gamma}}

\newcommand{\cellParams}{\ensuremath{\left\{ a,b,c,\dalfa,\dbeta,\dgama \right\}}}
\newcommand{\cellParamsRef}{\ensuremath{\left\{ a_0,b_0,c_0,\dalfa_0,\dbeta_0,\dgama_0 \right\}}}

\newcommand{\rcella}{\ensuremath{\mathbf{a}^*}}
\newcommand{\rcellb}{\ensuremath{\mathbf{b}^*}}
\newcommand{\rcellc}{\ensuremath{\mathbf{c}^*}}
\newcommand{\ralfa}{\ensuremath{\alpha^*}}
\newcommand{\rbeta}{\ensuremath{\beta^*}}
\newcommand{\rgama}{\ensuremath{\gamma^*}}

\newcommand{\rcellParams}{\ensuremath{\left\{ a^*,b^*,c^*,\ralfa,\rbeta,\rgama \right\}}}

\newcommand{\cellVol}{\ensuremath{v}}
\newcommand{\cellVolExpr}{\ensuremath{\dotp{\cella}{\crossp{\cellb}{\cellc}}}}
\newcommand{\strain}{\mbm{\epsilon}}

% CONVENIENCE
\newcommand{\coe}{\ensuremath{\cos\eta}}
\newcommand{\sie}{\ensuremath{\sin\eta}}
\newcommand{\cob}{\ensuremath{\cos\theta}}
\newcommand{\sib}{\ensuremath{\sin\theta}}
\newcommand{\cop}{\ensuremath{\cos\phi}}
\newcommand{\sip}{\ensuremath{\sin\phi}}
\newcommand{\cow}{\ensuremath{\cos\omega}}
\newcommand{\siw}{\ensuremath{\sin\omega}}
\newcommand{\cox}{\ensuremath{\cos\chi}}
\newcommand{\six}{\ensuremath{\sin\chi}}
\newcommand{\coxsq}{\ensuremath{\cos^2\chi}}
\newcommand{\sixsq}{\ensuremath{\sin^2\chi}}
\newcommand{\sitx}{\ensuremath{\sin{2\chi}}}

\newcommand{\nZ}{\ensuremath{n_0}}
\newcommand{\nO}{\ensuremath{n_1}}
\newcommand{\nT}{\ensuremath{n_2}}
\newcommand{\nZO}{\ensuremath{n_0n_1}}
\newcommand{\nZT}{\ensuremath{n_0n_2}}
\newcommand{\nOT}{\ensuremath{n_1n_2}}
\newcommand{\hgZ}{\ensuremath{\hat{G}_0}}
\newcommand{\hgO}{\ensuremath{\hat{G}_1}}
\newcommand{\hgT}{\ensuremath{\hat{G}_2}}
\newcommand{\hbZ}{\ensuremath{\hat{b}_0}}
\newcommand{\hbO}{\ensuremath{\hat{b}_1}}
\newcommand{\hbT}{\ensuremath{\hat{b}_2}}

% MATH OPERATORS
\newcommand{\rmat}[2]{\ensuremath{\mathsf{R}\left(#1,\;#2\right)}}
\newcommand{\sub}[2]{\ensuremath{#1_#2}}
\newcommand{\dotp}[2]{\ensuremath{#1\cdot#2}}
\newcommand{\crossp}[2]{\ensuremath{#1\times#2}}
\newcommand{\modulus}[2]{\mathop{\mathrm{mod}\left(\frac{#1}{#2}\right)}}
\newcommand{\skewMat}[1]{\ensuremath{
	\left[
		\begin{array}{rrr}
			    0 & -#1_2 &  #1_1 \;\\ 
			 #1_2 &     0 & -#1_0 \;\\
			-#1_1 &  #1_0 &     0 \;
		\end{array}
	\right]}}

\newcommand{\skewOp}[1]{\ensuremath{\mathrm{skew}\;#1}}

\newcommand{\symmMat}[1]{\ensuremath{
	\left[
		\begin{array}{ccc}
			#1_0 & #1_5 & #1_4 \\ 
			     & #1_1 & #1_3 \\
			\multicolumn{2}{l}{\text{\smash{\raisebox{0.35ex}{\;Sym.}}}} & #1_2 \\
		\end{array}
	\right]}}

\newcommand{\outerProdMat}[1]{\ensuremath{
	\left[
		\begin{array}{rrr}
			#1_0^2 & #1_0#1_1 & #1_0#1_2 \\ 
			       &   #1_1^2 & #1_1#1_2 \\
			\multicolumn{2}{l}{\text{\smash{\raisebox{0.35ex}{\;\;Sym.}}}} & #1_2^2 \\
		\end{array}
	\right]}}

\newcommand{\EyeMinusOuterProdMat}[1]{\ensuremath{
	\left[
		\begin{array}{rrr}
			1 - #1_0^2 &  -#1_0#1_1 & -#1_0#1_2 \\ 
			           & 1 - #1_1^2 & -#1_1#1_2 \\
			\multicolumn{2}{l}{\text{\smash{\raisebox{0.35ex}{\;\;Sym.}}}} & 1 - #1_2^2 \\
		\end{array}
	\right]}}

% --------------------- Document ---------------------
\begin{document}
\maketitle
\begin{abstract}
A complete and general geometric model for parameterizing diffraction
measurements with one or more planar detectors is presented.  It includes provisions for describing both mono- and poly-chromatic schemes for {\em collimated} incident beams (\ie\ negligible beam divergence), although extensions to divergent sources are discussed.  Detectors are modeled as polygonal planar bodies, and their shapes and placements in the reference frame are completely arbitrary.  The mapping that takes an admissible reciprocal lattice vector in the crystal frame to pixel coordinates in a specific detector frame is of the form $\mathbf{A}(\mathbf{x})\cdot\mathbf{x} =
\mathbf{y}$.  Application to the rotation method, including the effects of non-perpendicularity of the rotation axis to the incident beam wave vector, is presented in detail.
\end{abstract}

\newpage

\section{Background \& Motivation}

With many different measurement schemes, the rise of HEDM, and multi-panel instruments, it bears merit to revisit a generic geometric model suitable for implementation in data reduction software... standardization, {\em blah, blah, blah}

\section{Coordinate Systems}

A single-detector diffraction measurement schema is illustrated in
\figref{F:diffraction_schema}.  For generality we utilize five
fundamental coordinate systems:
\begin{itemize}
  \item the {\bf laboratory} frame, \labframe;
  \item the {\bf beam} frame, \beamframe;
  \item the {\bf detector} frame(s), $\detframe_i$;
  \item the {\bf sample} frame, \sampframe; and
  \item the {\bf crystal} frame, \crysframe.
\end{itemize}

\subsection{Laboratory Frame}\label{S:laboratory}
The laboratory frame is intended to provide a global reference frame
that is stationary during the measurement.  The incident beam has a
non-negligible physical extent in the lab frame, typically possessing
a rectangular or circular cross-section.  For clarity, we restricting
our focus to sources that may be described using plane waves.  With
regards to the geometric construction, it is useful to define the beam
direction as the unit incident wave vector,
$\bhat\equiv\frac{\mbm{k}_i}{\|\mbm{k}_i\|}$.  The centroid of the
beam cross-section is defined to coincide with the origin of
\labframe, labeled \Pzero.

\subsection{The Beam Frame}
When working with the geometry of diffraction, it becomes very useful
to associate detector-relative cartesian coordinates -- and
diffraction vectors \dhat\ -- with a Bragg angle, $2\theta$, and
azimuth, $\eta$.  Noting that the Bragg condition is axisymmetric
about the incident wave vector, a natural frame in which represent
these spherical angles has the origin at the diffracting element, and
incident beam aligned with one of the basis vectors.  In the present
notation, the Bragg angle (see \eqnref{E:braggCondition}) is defined
as
\begin{equation}
  2\theta \equiv \arccos{\left( \bhat \cdot \dhat \right)},
\end{equation}
where \dhat\ is the unit vector representing the direction of the
diffracted beam
\begin{displaymath}
  \dhat \equiv \frac{\Pfour-\Pthree}{\|\Pfour-\Pthree\|}.
\end{displaymath}
To define an azimuth, a reference direction, \ehat, must be specified.
The definition of a reference azimuth vector is arbitrary, however
\ehat\ and \bhat\ cannot be collinear.  The standard setting has
$\labcomps{\ehat}=\left[1\;0\;0\right]^T$.  The components \bhat\ in
the laboratory frame are parameterized by spherical angles $(\phi,
\gamma)$:
\begin{equation}
  \labcomps{\bhat} = -\begin{Bmatrix}
    \sin\phi \cos\gamma \\
    \sin\phi \sin\gamma \\
    \cos\phi
  \end{Bmatrix}.
\end{equation}
The standard setting has $\phi=\gamma=0$.  The basis vectors defining
the beam frame in the standard setting are
\begin{equation}
  \beamframe = \left[ \ehat,\; -\bhat\times\ehat,\; -\bhat \right].
  \label{E:etaFrame}
\end{equation}
The components of a unit diffraction vector in the beam frame are
\begin{equation}
  \beamcomps{\dhat} = \begin{Bmatrix}
    \sin2\theta \cos\eta \\
    \sin2\theta \sin\eta \\
    -\cos2\theta
  \end{Bmatrix},
\end{equation}
and the azimuth of a diffracted beam is obtained as
\begin{equation}
  \eta = \arccos{\left(\ehat \cdot \left( \eye - \bhat \otimes \bhat \right)\cdot\dhat\right)}.
\end{equation}
Lastly, the components of a reciprocal lattice vector, \gvec, are
simply
\begin{equation}
  \beamcomps{\gvec} = \frac{2\sin{\theta}}{\lambda}\begin{Bmatrix}
    \cos\eta \cos\theta \\
    \sin\eta \cos\theta \\
    \sin\theta
  \end{Bmatrix}
\end{equation}
where $\lambda$ is the \xray\ wavelength.

\subsection{Detector Frame}\label{S:detector}
A typical detector element has a planar active area with a rectangular
shape.  A complete instrument may contain several independent
detectors with unique orientations and placements in the lab frame.  A
cartesian coordinate system \detframe\ is attached to each independent
detector element as follows: the origin \Pone\ is coincident with the
centroid of the active surface, and \Zd\ represents the plane normal.
The \Xd,\Yd\ directions are typically aligned with the horizontal and
vertical pixel-relative directions on each panel.  The coordinates of
points in each independent detector coordinate system, \detframe\, are
related to coordinated in \labframe\ via a simple affine
transformation:
\begin{gather}
  \labcomps{\detpt} = \rmatd\cdot\detcomps{\detpt} + \labcomps{\tvecd}
\end{gather}
where $\tvecd = \Pone - \Pzero$ and the notation
$\labcomps{\detpt}$ indicates the components of $\detpt$ in
\labframe.  Because only planar detectors are considered, the
components of a detector-relative point are of the form
$\detcomps{\detpt}=[x\; y\; 0]$.

\subsection{Sample Frame}\label{S:sample}
The sample frame provides a basis in which to represent a uniquely
oriented and located specimen.  For the arbitrarily defined
sample-relative vector $\mathbf{S}$, coordinates in \sampframe\ are
connected to \labframe\ via the affine transformation
\begin{equation}
  \labcomps{\mathbf{s}} = \rmats\cdot\sampcomps{\mathbf{s}} + \labcomps{\tvecs}  
\end{equation}
where $\tvecs=\Ptwo-\Pzero$.  In the case of the rotation method, this
is frame is the oscillation frame.  Without loss of generality, the
oscillation axis is fixed to \Ys.  It may be canted with respect to
\Yl\ by the angle $\chi$\footnote{the canting angle $\chi$ is
  typically very small for an HEDM schema, although some special cases
  might require it to be set to some non-zero value.  Including this
  degree of freedom in the model also allows for it to be quantified
  via calibration.}.  The oscillation angle itself is represented by
$\omega$.  The full model has a sufficient number of degrees of
freedom to preclude the need for a third rotational degree of freedom
for \sampframe.

\subsection{Crystal Frame}\label{S:crystal}
The crystal frame represent a local RHON coordinate system attached to
the lattice of a single-crystal domain in the sample.  In the context
of far-field HEDM, the origin of \crysframe, labeled \Pthree,
represents the centroid of the crystallite.  For a crystal-relative
vector $\mathbf{c}$, the components are transformed as
\begin{align}
  \sampcomps{\mathbf{c}} &= \rmatc\cdot\cryscomps{\mathbf{c}} + \sampcomps{\tvecc}\\
  \labcomps{\mathbf{c}} &= \rmats\cdot\rmatc\cdot\cryscomps{\mathbf{c}} + \rmats\cdot\sampcomps{\tvecc} + \labcomps{\tvecs}
\end{align}
where $\tvecc=\Pthree-\Ptwo$.  The formulation of diffracted beam vectors for a given unit cell is discussed in \secref{S:diffraction}.
%%
\begin{figure}[htb]
  \centering
  \includegraphics[width=0.85\textwidth]{new_geometry.pdf}
  \caption{A single-detector diffraction schema illustrating the four
    fundamental coordinate systems and the 5 generic points
    \Pzero-\Pfour\ used to create the transfer function taking
    reciprocal lattice vector components to detector-relative
    components.  For completeness, the reciprocal lattice vector
    \gvec\ and Bragg angle $2\theta$ associated with \Pfour\ are
    shown.  The azimuthal angle, $\eta$, of \ghat\ about \bhat\ is not
    shown; however, the reference azimuth is, denoted by the unit
    vector \ehat. }
  \label{F:diffraction_schema}
\end{figure}
%%

\newpage
\section{Diffraction}\label{S:diffraction}
\subsection{Convention for writing components of crystal lattice vectors}\label{S:conventions}
In order to insert the geometry of diffraction into the coordinate
system hierarchy described above, it is necessary to etablish a
convention for describing the crystal lattice. The crystal lattice
itself may be parameterized by its primitive vectors \cella, \cellb,
and \cellc.  They share a common origin at a lattice site and are
subject to the following conditions:
%%
\begin{equation}
  \begin{array}{rcl}
    \|\cella\| &=& a\\
    \|\cellb\| &=& b\\
    \|\cellc\| &=& c\\
    {1 \over bc}\dotp{\cellb}{\cellc} &=& \cos\dalfa\\
    {1 \over ca}\dotp{\cellc}{\cella} &=& \cos\dbeta\\
    {1 \over ab}\dotp{\cella}{\cellb} &=& \cos\dgama
  \end{array} \label{E:lattParams}
\end{equation}
%%
The six scalar cell parameters \cellParams\ represent a convenient
parameterization of the reference unit cell, which typically
correspond to an unloaded state at a reference temperature. Crystal
symmetry operations (excluding triclinic) generate equivalences among
cell parameters; however once a crystal is deformed, the reference
symmetry is broken and all six parameters must be considered as
independent.  The treatment of strained crystals in the context of the
reference crystal symmetry is discussed in detail below.  For writing
components of crystal-relative vectors and tensors in \crysframe, a
convention must be chosen to register the lattice vectors.  The
convention employed herein is consistent with that proposed by
\cite{Nye:crysBookAppB}.  Explicitly stated, $\cella\parallel\Xc$ and
$(\crossp{\cella}{\cellb})\parallel\Zc$, as depicted in
\figref{F:lattice}.
%%
\begin{figure}[ht]
  \centering
  \includegraphics[width=0.6\textwidth]{unitCell.pdf}
  \caption{The convention for describing the
    reference (read: unstrained) lattice has $\cella\parallel\Xc$ and
    $\rcellc\parallel\Zc$. Note that a triclinic
    primitive cell is depicted for generality.  The crystal orientation, \rmatc,
    takes components in the crystal frame, \crysframe, to the sample
    frame, \sampframe.}
  \label{F:lattice}
\end{figure}
%%

The reciprocal lattice, which forms a dual basis to the direct
lattice, is a very useful concept in diffraction.  The reciprocal
lattice vectors are defined\footnote{this is the so-called
``crystallographer's convention'' where the prefactor of $2\pi$ is
omitted.} as follows:
%%
\begin{align}
  \rcella = {1 \over v}\crossp{\cellb}{\cellc}\\
  \rcellb = {1 \over v}\crossp{\cellc}{\cella}\\
  \rcellc = {1 \over v}\crossp{\cella}{\cellb}
\end{align}
%%
where $\cellVol = \cellVolExpr$ represents the volume of the primitive
cell, and \rcellParams\ are the reciprocal lattice parameters defined
analogously to the direct lattice parameters in \figref{F:lattice} and
\eqnref{E:lattParams}.  With \crysframe\ define with reference to
\cellParams\ and \rcellParams, we define the change-of-basis matrix,
\amat, which takes components in the direct lattice frame to the
\crysframe as
%%
\begin{align}
  \amat &\equiv \cryscomps{\cella\;\cellb\;\cellc} \label{E:amatrix}\\
        &= \begin{bmatrix}
              a & b\cos{\gamma} & c\cos{\beta} \\
              0 & b\sin{\gamma} & -c\cos{\alpha^*}\sin{\beta} \\
              0 & 0 & c\sin{\alpha^*}\sin{\beta}
           \end{bmatrix}. \nonumber
\end{align}
%%
Note that an identity from \citet{Neustadt:a05876} is employed to
simplify the components for \amat.  Analogously the change-of-basis
matrix, \bmat, that takes vector components in the reciprocal lattice
frame to the crystal frame is defined as
%%
\begin{align}
  \bmat &\equiv \cryscomps{\begin{matrix} \rcella & \rcellb & \rcellc \end{matrix}} \label{E:bmatrix}\\ 
        &= \frac{1}{\cellVol}\begin{bmatrix}
           bc\sin{\ralfa}\sin{\dbeta}\sin{\dgama} &                          0 &                                           0 \\
          -bc\sin{\ralfa}\sin{\dbeta}\cos{\dgama} & ac\sin{\ralfa}\sin{\dbeta} &                                           0 \\
          -bc(\cos{\ralfa}\sin{\dbeta}\cos{\dgama} + \cos{\dbeta}\sin{\dgama}) & ac\cos{\ralfa}\sin{\dbeta} & ab\sin{\dgama}
	\end{bmatrix}, \nonumber
\end{align}
%%

Assume that a reciprocal lattice vector, \gvec, satisfies a Bragg condition.  The unit vector aligned with its associated diffracted beam, \dhat, is then
\begin{align}
\dhat &= \mathsf{R}\left(\pi, \ghat\right)\cdot\left(-\bhat\right) \nonumber\\
      &= \left(2\ghat\otimes\ghat - \eye\right)\cdot\left(-\bhat\right) \nonumber\\
      &= \left(\eye - 2\ghat\otimes\ghat\right)\cdot\bhat \label{E:dhat}\\
      & \mbox{where } \ghat\cdot\bhat = -\frac{\lambda}{2}\|\gvec\| = -\sin{\theta},  \label{E:braggCondition}\\
      & \dhat\cdot\Zd < 0,  \label{E:intersectsDetector}
\end{align}
$\ghat=\gvec / \|\gvec\|$, and \bhat\ is the unit vector aligned with the beam propagation direction.  \eqnref{E:braggCondition} is the Bragg condition for \xrays\ having wavelength $\lambda$, and \eqnref{E:intersectsDetector} is the geometric condition ensuring that \dhat\ can intersect the detector plane.  Note that there is an additional condition that must be satisfied in the instrument for \Pfour\ to be observable; it must also lie within the physical extent of the detector element.  Application of this condition is, however, quite straightforward and not explicitly stated in this document.
%
\subsection{Representing crystal orientation and strain}
A reciprocal lattice vector, \gvec, is typically representend by its components in the reference (read: undistorted) reciprocal lattice frame, $\rcpcomps{\gvec}=[h\; k\; l]$.  The change-of-basis matrix, \bmat, that takes components in the reciprocal lattice to \crysframe\ was given by \eqnref{E:bmatrix} above (\secref{S:conventions}).  The effects of both finite distortion and rotation of a crystal lattice with respect to \sampframe\ are captured using a deformation gradient tensor, \defgrad, as presented in \cite{Bernier:2011uq}.  The tensor \defgrad\ acts on the {\em direct} lattice vectors, and takes undistorted lattice vectors in the reference crystal frame, \crysframe, to reoriented and distorted lattice vectors in the sample frame, \sampframe.  Using the polar decomposition, 
\begin{equation}
    \defgrad = \vmat \rmatc,\; \forall\; \vmat \in Sym^{3\times3},\; \rmatc \in SO^3,
\end{equation}
where \rmatc\ is the crystal orientation and \vmat\ is the ``left'' stretch tensor.  \citet{Edmiston2012} have shown that 
$\defgrad^{-T}=\vmat^{-1}\rmatc$ 
can be applied analogously to reciprocal lattice vector components written in \crysframe.
Given the reciprocal lattice vector \gvec, with components $\rcpcomps{\gvec}=[h\; k\; l]$ in the reciprocal lattice frame, the fully distorted and orientend components in \labframe\ are then derived as
\begin{align}
\labcomps{\gvec} &= \rmats \sampcomps{\gvec} \nonumber\\
                 &= \rmats \sampcomps{\defgrad^{-T}} \cryscomps{\gvec} \nonumber\\
                 &= \rmats \sampcomps{\defgrad^{-T}} \bmat \rcpcomps{\gvec} \nonumber\\
        \Aboxed{ &= \rmats \sampcomps{\vmat^{-1}} \rmatc \bmat \rcpcomps{\gvec} }\label{E:gvecLab},
\end{align}
The three crystal orientation degrees of freemdom are wrapped up in \rmatc, while the six that represent strain are contained in \vmat.  

Functionally, the orientation degrees of freedom can be decoupled from the strain (and position) degrees of freedom in the initial analysis.  This ``orientation indexing'' procedure essentially consists of testing discrete orientations $\mathsf{R}(\phi, \mbm{n})$, for a set of feasible \gvec\ and checking for intensity at the associated detector points \Pfour.  For the rotation method, the oscillation angle $\omega$ must be calculated for each feasible \gvec\ as well; this will be discussed in \secref{S:oscill}.

\section{Parametric ray-plane intersection and the transform function}\label{S:transform}
The coordinates of the points $\Pzero-\Pfour$ (see \figref{F:diffraction_schema}) in the lab frame are
\begin{align}
  \labcomps{\Pzero}  &\equiv \begin{bmatrix} 0 & 0 & 0 \end{bmatrix} \\
  \labcomps{\Pone}   &= \labcomps{\tvecd} \\
  \labcomps{\Ptwo}   &= \labcomps{\tvecs} \\
  \labcomps{\Pthree} &= \rmats\sampcomps{\tvecc} + \labcomps{\tvecs} \\
  \labcomps{\Pfour}  &= \rmatd\detcomps{\detpt} + \labcomps{\tvecd}
\end{align}
Using the parametric equations for a plane (\eqnref{E:plane}) and line (\eqnref{E:line}), we may obtain a system of equations linking \dhat\ and \Pfour.
\begin{gather}
\Zd \cdot (\Pfour - \Pone) = 0 \label{E:plane}\\
\Pfour = \Pthree + u\dhat \label{E:line}
\end{gather}
Substituting for \Pfour\ and rearranging to solve for the scale parameter $u$ yields
\begin{align}
    \Zd \cdot (\Pthree - \Pone + u\dhat) &= 0 \nonumber\\
    \Zd \cdot (\Pthree - \Pone) &= -u\Zd \cdot \dhat \nonumber\\
    \implies u &= \frac{\Zd \cdot (\Pone - \Pthree)}{\Zd \cdot \dhat
    }
\end{align}
Finally, inserting this result into \eqnref{E:line} with some rearrangement yields
%\begin{equation}
%  \detcomps{\Pfour} = \rmatd^T\cdot\labcomps{ \rmats\tvecc+\tvecs-\tvecd 
%    - \frac{\left(\rmatd\Zl\right)\cdot\left(\rmats\tvecc+\tvecs-\tvecd\right)}
%           {\left(\rmatd\Zl\right)\cdot\dhat}\cdot\dhat },
%\end{equation}
%or in component form:
\begin{equation}
  \boxed{\detcomps{\Pfour} = \rmatd^T \cdot \left[ \labcomps{\Pthree - \Pone} 
    - \frac{\mathrm{dot}\left(\labcomps{\Zd}^T,\; \labcomps{\Pthree - \Pone}\right)}
           {\mathrm{dot}\left(\labcomps{\Zd}^T,\; \labcomps{\dhat}\right)}\labcomps{\dhat} \right] }, \label{E:Pfour}
\end{equation}
where $\labcomps{\dhat}$ is obtained from \eqnref{E:dhat} and \eqnref{E:gvecLab}.
% as
%\begin{align}
%  \dhati &= \left(\delta_{ij} - 2\ghati\ghatj\right)\cdot\bhatj
%\end{align}
%%
\section{Solving for the oscillation angle, $\omega$}\label{S:oscill}
For a monochromatic schema using the rotation method, the action of the oscillation in a canted configuration is represented by the rotation \rmats\, where
\begin{align}
	\rmats &= \rmat{\chi}{\Xl}\rmat{\omega}{\Yl} \label{E:rmats} \\
	&= \left[\begin{array}{rrr}1&0&0\\0&\cox&-\six\\0&\six&\cox\end{array}\right]
	   \left[\begin{array}{ccc}\cow&0&\siw\\0&1&0\\-\siw&0&\cow\end{array}\right] \nonumber\\
	&= \left[\begin{array}{ccc} 
	       \cow     &  0   &      \siw \\
	       \six\siw & \cox & -\six\cow \\
	      -\cox\siw & \six &   \cox\cow
	   \end{array}\right] . \nonumber
\end{align}
From \eqnref{E:gvecLab} we have
\begin{equation}
    \sampcomps{\gvec} = \sampcomps{\defgrad^{-T}}\bmat\rcpcomps{\gvec} \label{E:ghatInSamp}
\end{equation}
By writing the Bragg condition (\eqnref{E:braggCondition}) in terms of lab-frame components by multiplying by the normalized components $\sampcomps{\ghat}$ above by \rmats\ leads to relation of the form 
\begin{align}
    a \siw + b \cow &= c \label{E:trig}\\
                    &\equiv R\sin{\left(x+\alpha\right)} \label{E:identity}\\
                    \mbox{where } R\equiv\sqrt{a^2 + b^2} &\mbox{, and } \alpha\equiv\mathrm{atan2}(b, a),
\end{align}
and 
%%
\begin{align}
    a = \sampcomps{\hgT}\labcomps{\hbZ} &+ \six\sampcomps{\hgZ}\labcomps{\hbO} - \cox\sampcomps{\hgZ}\labcomps{\hbT}\\
    b = \sampcomps{\hgZ}\labcomps{\hbZ} &- \six\sampcomps{\hgT}\labcomps{\hbO} + \cox\sampcomps{\hgT}\labcomps{\hbT}\\
    c =                  -\sin{\theta} &- \cox\sampcomps{\hgO}\labcomps{\hbO} - \six\sampcomps{\hgO}\labcomps{\hbT}
\end{align}
%%
These yield the solutions
\begin{equation}
    \omega = \left\{
        \begin{array}{r} 
            \arcsin{ \left( \frac{c}{\sqrt{a^2 + b^2}} \right) } - \alpha \\ 
            \pi - \arcsin{ \left(\frac{c}{\sqrt{a^2 + b^2}}\right) } - \alpha \\
        \end{array}
    \right. \label{E:omegas}
\end{equation}
which are either unique (both sides of the diffraction cone), a double root (tangent to the diffraction cone -- typically not considered) or do not exist ($|\frac{c}{\sqrt{a^2 + b^2}}| > 1$, can't intersect diffraction cone).

\section{Summary}\label{S:summary}
The complete procedure for finding the detector coordinates of all reflections for a specifically oriented, strained crystal at the the position \Pthree\ consists of the following procedure:
\begin{enumerate}
\item Generate $[h\; k\; l]$ up to the relevant order (determined by geometry and wavelength of the \xrays) \\
\item Calculate the set of reciprocal lattice vector components in \sampframe\ using \eqnref{E:ghatInSamp} \\
\item Calculate the set of oscillation angles, $(\omega_0,\; \omega_1)$, for each unique $[h\; k\; l]$ using \eqnref{E:omegas}\\
\item Calculate the set of unit diffraction vector components in \labframe\ using \eqnref{E:rmats}, \eqnref{E:gvecLab}, \eqnref{E:dhat} for each valid oscillation angle pair in $(\omega_0,\; \omega_1)$\\
\item Calculate $\detcomps{\Pfour}$ from \eqnref{E:Pfour}.
\end{enumerate}

\begin{appendix}
\section{Tilt parameterization}
\subsection{Tait-Bryan angles}
Passive convention.
\begin{align}
\rmatd &= \rmat{\zeta}{\Zl}\rmat{\psi}{\Yl}\rmat{\phi}{\Xl} \label{E:rmatd} \\
	&= 	\begin{bmatrix} 
			\cos{\zeta} & -\sin{\zeta} &  0  \\
			\sin{\zeta} &  \cos{\zeta} &  0  \\
			 0  &  0  &  1 
		\end{bmatrix}
		\begin{bmatrix} 
			\cos{\psi} &  0  & \sin{\psi} \\
			 0  &  1  &  0  \\
			-\sin{\psi} &  0  & \cos{\psi}
		\end{bmatrix}
		\begin{bmatrix} 
			 1  &  0  &  0  \\
			 0  & \cos{\phi} & -\sin{\phi} \\
			 0  & \sin{\phi} & \cos{\phi}
		\end{bmatrix} \nonumber\\
	&= 	\begin{bmatrix} 
			\cos{\zeta} & -\sin{\zeta} &  0  \\
			\sin{\zeta} &  \cos{\zeta} &  0  \\
			 0  &  0  &  1 
		\end{bmatrix}
		\begin{bmatrix} 
			\cos{\psi} &  \sin{\psi}\sin{\phi}  & \sin{\psi}\cos{\phi} \\
			 0  &  \cos{\phi}  &  -\sin{\phi}  \\
			-\sin{\psi} &  \cos{\psi}\sin{\phi}  & \cos{\psi}\cos{\phi}
		\end{bmatrix} \nonumber\\
	&= \begin{bmatrix} 
			\cos{\zeta}\cos{\psi} & \cos{\zeta}\sin{\psi}\sin{\phi} - \sin{\zeta}\cos{\phi} & \cos{\zeta}\sin{\psi}\cos{\phi} + \sin{\zeta}\sin{\phi} \\
			\sin{\zeta}\cos{\psi} & \sin{\zeta}\sin{\psi}\sin{\phi} + \cos{\zeta}\cos{\phi} & \sin{\zeta}\sin{\psi}\cos{\phi} - \cos{\zeta}\sin{\phi} \\
			-\sin{\psi} & \cos{\psi}\sin{\phi} & \cos{\psi}\cos{\phi}
		\end{bmatrix} \nonumber
\end{align}
\end{appendix} 
\bibliographystyle{abbrvnat}
\bibliography{hedm}

\end{document}

